/// Generates kpi class
Class SQLKPI.Generator [ Abstract ]
{

/// This XData definition defines the kpi.
XData kpi
{
<kpi
xmlns="http://www.intersystems.com/deepsee/kpi"
 name="!!!1!!!" sourceType="sql"
 sql="!!!2!!!">
}

/// do ##class(SQLKPI.Generator).generateKPIClass("SELECT name, type FROM Sample.Per", "KPIName", "try.kpi") 
ClassMethod generateKPIClass(sql As %String, name As %String, class As %String)
{
	#dim sc As %Status = $$$OK
	
	if '##class(%Dictionary.ClassDefinition).%ExistsId(class) {
		set classObj = ##class(%Dictionary.ClassDefinition).%New(class)
		set classObj.GeneratedBy = "SQLKPI.Generator"
		set classObj.Super = "%DeepSee.KPI"
		set classObj.Description = "This kpi class was automatically generated by SQLkpi utility."
	} else {
		set classObj = ##class(%Dictionary.ClassDefinition).%OpenId(class)
		do classObj.XDatas.Clear()
	}
	
	set kpi = ##class(%Dictionary.XDataDefinition).%New(class _ ":kpi")
	set kpi.XMLNamespace = "http://www.intersystems.com/deepsee/kpi"
	
	set header = ##class(%Dictionary.XDataDefinition).IDKEYOpen($classname(), "kpi").Data.Read(10000)
	do ..ReplaceRegexp(.header, "!!!1!!!", name)
	do ..ReplaceRegexp(.header, "!!!2!!!", sql)
	do kpi.Data.WriteLine(header) 
	
	set st = ##class(%SQL.Statement).%New()
	set sc = st.%Prepare(sql)
	quit:$$$ISERR(sc) sc
	
	#dim result As %SQL.StatementResult
	set result = st.%Execute()
	
	#dim metadata As SQL.StatementMetadata
	set metadata = result.%GetMetadata()
	set columnCount = metadata.columns.Count()
	for i=1:1:columnCount {
		#dim column As %SQL.StatementColumn
		set column = metadata.columns.GetAt(i)
		do kpi.Data.WriteLine("<property name=""" _ column.colName  _ """/>")	
	}
	do kpi.Data.Write("</kpi>")
	
	do classObj.XDatas.Insert(kpi)
	
	set sc = classObj.%Save()
	return:$$$ISERR(sc) sc
	return $System.OBJ.Compile(class, "cuks /displaylog=0 /displayerror=0")
}

/// Replaces all occurances of Pattern with ReplacePattern.
/// w $System.Status.GetErrorText(##class(SQLKPI.Generator).ReplaceRegexp(.Text))
ClassMethod ReplaceRegexp(ByRef Text, Pattern As %String = "", ReplacePattern As %String = "") As %Status
{
	#Dim Matcher As %Regex.Matcher = ##class(%Regex.Matcher).%New(Pattern, Text)
	Set Text = Matcher.ReplaceAll(ReplacePattern)
    Quit Matcher.Status
}

}

