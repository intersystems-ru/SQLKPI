<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="SQLKPI.REST">
<Super>SQLKPI.AbstractREST</Super>
<TimeCreated>64244,40141.013098</TimeCreated>

<XData name="UrlMap">
<XMLNamespace>http://www.intersystems.com/urlmap</XMLNamespace>
<Data><![CDATA[
<Routes>
<Route Url="/sql" Method="POST" Call="executeSQL"/>
<Route Url="/kpi" Method="POST" Call="generateKPI"/>
<Route Url="/logout" Method="GET" Call="logout"/>
<Route Url="/test" Method="GET" Call="test"/>
</Routes>
]]></Data>
</XData>

<Method name="logout">
<Description>
Logout current session</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    #dim %session As %CSP.Session
    set st = %session.Logout(1)
    set %session.EndSession = 1
    return st
]]></Implementation>
</Method>

<Method name="test">
<Description>
Test</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    write "{""Status"": ""OK""}"
    return $$$OK
]]></Implementation>
</Method>

<Method name="executeSQL">
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	#dim sc As %Status = $$$OK
	set provider = ##class(%ZEN.Auxiliary.altJSONSQLProvider).%New()
	set provider.maxRows = $$$MaxCacheInt
	set provider.%Format = "tw"
	set provider.sql = %request.Content.SQL
	set sc = provider.%DrawJSON()
	return sc
]]></Implementation>
</Method>

<Method name="generateKPI">
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set sql = %request.Content.SQL
	set name = %request.Content.Name
	set class = %request.Content.Class
	
	// TODO check that it's valid
	
	return ##class(SQLKPI.Generator).generateKPIClass(sql, name, class)
]]></Implementation>
</Method>
</Class>
</Export>
